<div class="page-header">
  <h1>{{pageName}}</h1>
</div>

<style>
  .disabled-room { cursor: not-allowed !important; opacity: 0.6; pointer-events: none; }
  .search-box { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.1); margin-top: -50px; position: relative; z-index: 10; }
</style>

<div class="container">
  <div class="search-box mb-5">
    <form id="searchForm" class="row g-3 align-items-end">
      <div class="col-md-3"><label class="form-label fw-bold">Check-in</label><input type="date" id="checkIn" class="form-control" required></div>
      <div class="col-md-3"><label class="form-label fw-bold">Check-out</label><input type="date" id="checkOut" class="form-control" required></div>
      <div class="col-md-3"><label class="form-label fw-bold">Guests</label><input type="number" id="guests" class="form-control" value="1" min="1" required></div>
      <div class="col-md-3"><button type="submit" class="btn btn-danger w-100 fw-bold py-2">Update Search</button></div>
    </form>
  </div>
  <div class="row" id="roomsContainer"><div class="text-center py-5"><img src="/img/loading.gif" alt="Loading..." style="width: 50px;"></div></div>
</div>

<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white"><h5 class="modal-title fw-bold">Xác nhận đặt phòng</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="confirmBookingForm">
          <input type="hidden" id="modalRoomId">
          <div class="alert alert-light border"><strong>Phòng:</strong> <span id="modalRoomName"></span><br><strong>Giá:</strong> <span id="modalRoomPrice" class="text-danger fw-bold"></span> / đêm</div>
          <div class="mb-3"><label class="form-label fw-bold">Dịch vụ thêm (Tùy chọn)</label><div id="servicesList" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;"><div class="text-center text-muted small">Đang tải dịch vụ...</div></div></div>
          <div class="mb-3"><label class="form-label fw-bold">Mã giảm giá</label><div class="input-group"><span class="input-group-text"><i class="bi bi-ticket-perforated-fill"></i></span><input type="text" id="promoCode" class="form-control" placeholder="Nhập mã (nếu có)"></div></div>
        </form>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button><button type="button" class="btn btn-danger fw-bold" onclick="submitBooking()">Xác nhận & Thanh toán</button></div>
    </div>
  </div>
</div>

<script>
  const today = new Date().toISOString().split('T')[0];
  const tomorrowDate = new Date(); tomorrowDate.setDate(tomorrowDate.getDate() + 1);
  const tomorrow = tomorrowDate.toISOString().split('T')[0];
  const elCheckIn = document.getElementById("checkIn"); const elCheckOut = document.getElementById("checkOut"); const elGuests = document.getElementById("guests");
  elCheckIn.min = today; elCheckOut.min = tomorrow;

  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('checkIn')) {
    elCheckIn.value = urlParams.get('checkIn'); elCheckOut.value = urlParams.get('checkOut'); elGuests.value = urlParams.get('guests') || 1; loadRooms(true);
  } else {
    elCheckIn.value = today; elCheckOut.value = tomorrow; loadRooms(false);
  }

  document.getElementById("searchForm").addEventListener("submit", (e) => { e.preventDefault(); loadRooms(true); });

  // LOAD SERVICE TỪ PROXY LOCAL (Sửa lại dòng này để fix lỗi không hiện service)
  let availableServices = [];
  fetch('/api/services-list') // Gọi vào route của Node frontend
    .then(res => res.json())
    .then(data => { availableServices = data; renderServicesInModal(); })
    .catch(err => { console.error("Lỗi tải dịch vụ:", err); document.getElementById('servicesList').innerHTML = '<div class="text-danger small">Lỗi tải dịch vụ</div>'; });

  function renderServicesInModal() {
    const list = document.getElementById('servicesList');
    if (!availableServices || !availableServices.length) { list.innerHTML = '<div class="text-muted small">Không có dịch vụ nào.</div>'; return; }
    let html = '';
    availableServices.forEach(s => {
      const price = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(s.price);
      html += `<div class="form-check d-flex justify-content-between align-items-center mb-2"><div><input class="form-check-input service-checkbox" type="checkbox" value="${s.service_code}" id="svc_${s.service_id}"><label class="form-check-label" for="svc_${s.service_id}">${s.name}</label></div><span class="badge bg-light text-dark border">${price}</span></div>`;
    });
    list.innerHTML = html;
  }

  async function loadRooms(isSearch = false) {
    const container = document.getElementById("roomsContainer");
    container.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-danger"></div></div>`;
    try {
      let url = "http://217.216.72.223:3000/api/rooms";
      if (isSearch && elCheckIn.value && elCheckOut.value) url = `http://217.216.72.223:3000/api/rooms/search?checkIn=${elCheckIn.value}&checkOut=${elCheckOut.value}`;
      const res = await fetch(url); const rooms = await res.json();
      container.innerHTML = "";
      if (!rooms.length) { container.innerHTML = `<h4 class="text-center text-muted w-100">Không tìm thấy phòng trống!</h4>`; return; }
      rooms.forEach(room => {
        const isDisabled = isSearch ? false : (room.status !== "available");
        const price = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(room.price_per_night);
        const card = `<div class="col-md-4 mb-4"><div class="card border-0 shadow-sm ${isDisabled ? "disabled-room" : ""}"><img src="https://images.unsplash.com/photo-1611892440504-42a792e24d32" class="card-img-top" height="250" style="object-fit:cover" /><div class="card-body text-center"><h4>Room ${room.room_number} — ${room.room_type_name || "Standard"}</h4><p class="text-muted">${room.description || "Mô tả..."}</p><p><strong>Price:</strong> ${price}</p><p><strong>Max Guests:</strong> ${room.max_guests}</p>${isDisabled ? `<span class="badge bg-secondary mb-3">${room.status}</span>` : `<span class="badge bg-success mb-3">Available</span>`}<br><button onclick="openBookingModal(${room.room_id || room.id}, '${room.room_number}', '${room.room_type_name || "Standard"}', '${price}')" class="btn btn-danger w-100 rounded-pill py-2 fw-bold" ${isDisabled ? "disabled" : ""}>Book Now</button></div></div></div>`;
        container.insertAdjacentHTML("beforeend", card);
      });
    } catch (err) { container.innerHTML = `<p class="text-danger text-center w-100">Lỗi kết nối API!</p>`; }
  }

  function openBookingModal(roomId, roomNum, roomType, price) {
    if(!elCheckIn.value || !elCheckOut.value) { alert("Vui lòng chọn ngày Check-in và Check-out!"); return; }
    document.getElementById('modalRoomId').value = roomId;
    document.getElementById('modalRoomName').innerText = `Room ${roomNum} (${roomType})`;
    document.getElementById('modalRoomPrice').innerText = price;
    document.querySelectorAll('.service-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('promoCode').value = '';
    new bootstrap.Modal(document.getElementById('bookingModal')).show();
  }

  async function submitBooking() {
    const roomId = document.getElementById('modalRoomId').value;
    const selectedServices = [];
    document.querySelectorAll('.service-checkbox:checked').forEach(cb => selectedServices.push({ serviceCode: cb.value, quantity: 1 }));
    try {
      const res = await fetch("/booking/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ roomId, checkIn: elCheckIn.value, checkOut: elCheckOut.value, guests: elGuests.value, services: selectedServices, promotionCode: document.getElementById('promoCode').value.trim() })
      });
      if (res.status === 401) { alert("Bạn cần đăng nhập để đặt phòng!"); window.location.href = "/auth/login"; return; }
      const result = await res.json();
      if (result.success) window.location.href = `/payment/${result.data.booking_id}`;
      else alert("❌ Lỗi: " + result.message);
    } catch (err) { alert("Có lỗi xảy ra khi kết nối server!"); console.error(err); }
  }
</script>